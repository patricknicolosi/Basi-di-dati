<html>

<head>
    <title>Database</title>
    <link rel="stylesheet" href="../style.css">
    <meta charset="UTF-8">
</head>

<body>
    <header>
        <a class="nav-link" href="https://dbis-uibk.github.io/relax/calc/local/uibk/local/0" target="_blank">Simulatore
            RelaX</a>
        <a class="nav-link" href="https://www.mycompiler.io/it/new/sql">Simulatore SQL</a>
        <a class="nav-link" href="../index.html" target="_self">Home</a>
        <h1>Database</h1>
    </header>

    <section>
       <p>
        <pre>
            Si consideri lo schema:
            Impiegato(Nome,Salario,DipNum)
            Dipartimento(DipNum,NomeManager)
        </pre>
       </p>
        <code>
            <span class="code-title">Una regola, che quando il dipartimento cancellato, mette ad un valore di default (99) il valore DipNum degli impiegati appartenenti a quel dipartimento</span>
            <pre>
                CREATE TRIGGER SetDefaultDipNum ON
                AFTER DELETE ON Dipartimento
                FOR EACH row
                UPDATE Impiegato
                SET dipnum=99
                WHERE dipnum = OLD.dipnum
            </pre>            
        </code>
        <p>
            QUello che il trigger fa nello specifico è:
        </p>
        <ol>
            <li>
                Ascoltare l'eliminazione sulla tabella dipartimento
            </li>
            <li>
                Per ogni riga eliminata da Dipartimento, aggiorna Impiegato, settando dipnum=99 dove Impiegato.dipnum = OLD.dipnum. In altre parole, setta il valore
                99 in Impiegato li dove il valore di Impiegato.dipnum è uguale al valore vecchio (OLD) di Dipartimento.dipnum.
            </li>
            <li>
                Il trigger viene eseguito dopo che nella tabella Dipartimento sono stati eliminati i record.
            </li>
        </ol>
        <code>
            <span class="code-title">una regola che cancella tutti gli impiegati appartenenti a un dipartimento quando quest'ultimo cancellato;</span>
            <pre>
                CREATE TRIGGER EliminaAssociati ON
                AFTER DELETE ON Dipartimento
                FOR EACH row
                DELETE Impiegato
                WHERE dipnum = OLD.dipnum
            </pre>    
        </code>
        <code>
            <span class="code-title">una regola che, ogni qual volta il salario di un impiegato supera il salario del suo nanager, pone tale salario uguale al salario del manager;</span>
            <pre>
                CREATE TRIGGER Allinea
                AFTER UPDATE ON Impiegato
                FOR EACH ROW
                BEGIN
                    -- Verifica se il salario dell'impiegato supera quello del manager
                    IF NEW.salario > (
                        SELECT Impiegato.salario
                        FROM Impiegato, Dipartimento
                        WHERE Dipartimento.nomemanager = Impiegato.nome AND Dipartimento.dipnum = Impiegato.dipnum
                    ) THEN
                        -- Aggiorna il salario dell'impiegato con il salario del manager
                        UPDATE Impiegato
                        SET salario = (
                            SELECT Impiegato.salario
                            FROM Impiegato, Dipartimento
                            WHERE Dipartimento.nomemanager = Impiegato.nome AND Dipartimento.dipnum = Impiegato.dipnum
                        )
                    END IF;
                END;
            </pre>
        </code>
        <p>
            La particolarità di quest'ultimo trigger, è che chiama una modifica su stesso, è qualcosa del tipo:
        </p>
        <img src="../assets/1.png" alt="">
        <p>
            Tuttavia visto che viene gestita correttamente la condizione di uscita, la cosa funziona correttamente e non entriamo in un loop ricorsivo.
        </p>
        <code>
            <span class="code-title">una regola che, ogni qualvolta vengono modificati i salari, verifica che non vi siano dipartimenti in cui il salario medio cresce più del 3%, e in tal caso annulla la modifica</span>
        </code>
       
    </section>
    <section>
        <code>
            <span class="code-title">Dato il precendete schema relazionale trovare in SQL tutti quei dipartimenti che hanno media maggiore di 1500</span>
            SELECT DISTINCT Dipartimento.dipnum FROM Dipartimento JOIN (SELECT I.dipnum,AVG(I.salario) as media FROM Impiegato I GROUP BY I.dipnum HAVING media > 1500) as stipendi ON stipendi.dipnum = Dipartimento.dipnum 
            <span class="code-subtitle"><a href="https://www.mycompiler.io/view/CYrtvjvBANt" target="_blank" rel="noopener noreferrer">Test</a></span>
        </code>
    </section>
</body>

</html>